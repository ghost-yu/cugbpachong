name: Grade Monitor

on:
  schedule:
    # 每2小时运行一次（降低频率，减少风控）
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  check_grade:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # --- 安装Chrome浏览器（GitHub Actions自带，但确保最新版）---
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable

      # --- 安装依赖：undetected-chromedriver ---
      - name: Install dependencies
        run: |
          pip install undetected-chromedriver requests

      # --- 运行监控脚本（增加重试次数到5次）---
      - name: Run Monitor Script with Retry
        env:
          STUDENT_ID: ${{ secrets.STUDENT_ID }}
          PASSWORD: ${{ secrets.PASSWORD }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        run: |
          # 最多重试5次，每次间隔3分钟
          for i in {1..5}; do
            echo "===== 尝试第 $i/5 次运行 ====="
            if python main_simple.py; then
              echo "✓ 运行成功！"
              exit 0
            fi
            if [ $i -lt 5 ]; then
              echo "失败，等待3分钟后重试..."
              sleep 180
            fi
          done
          echo "❌ 5次尝试均失败，但不阻止后续运行"
          exit 0  # 改为不失败，避免发送失败通知

      # 上传截图（如果 Selenium 截图成功的话）
      - name: Upload Debug Screenshots
        if: always() 
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: "*.png"
          retention-days: 3
